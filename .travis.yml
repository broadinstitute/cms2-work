sudo: required

dist: focal
os: linux

git:
#  depth: 5
  submodules: false

services:
  - docker

env:
#  - LANGUAGE=cwl
  global:
    - PYTHONIOENCODING=UTF8
    - LANGUAGE=wdl
    # GH_TOKEN
    - secure: "e0NeqS9TvUpwPzPo5tfFK7jBhHEgxnir+AEz7PSedhTngnPXUJEq/RyU9Q29mnH/SVWd9naqWBtROqmUszGvwnNcHo2SvP416rWcmXDSsJSB7hnTpODiN0hJiiHFxrKxnCImhnvO2PttOoMdaM5bhGDnx88if/8agNAuFbVRcT7mvTHn8EcXJtU2hAfHv6erMtqtLu7hcrIEM2pe9Qft2oCnMbeI42ti9NekHPiZFo+VTHfyb9aN5YdeJQSMRnDhPA/+LUISIAELn/PN2A0W0RF7Wlfv194DNR80ZN3GLYtl05Ve1HT6pF5le28yjXCtOvh97QAK547d1716OhPXJ6vXMHGwPO0SXLjFIeY9HqkoxsNC0cEX+sk9tMGmHKesHuK9kIu2v3BW03vHcrQgZvOIJ3BJKwtczLJfGgHzI9Y4tFDRxQaCKhk8ObFC7mcYTm3l/KxpUHsj/1aV2BzMzHlZ7oNZC3dZWNVRSkCOENVWDW4ZCiINGkdWZlagm4Jy+1fkXloE6M61EMaAHT9SgXdGc97UDegKx75xhJOXSld1FJzJNg5WcaQkiC7r7k3mjD5guDyVWUDk3dAxJTRyRHw83/nP+ylzX8QYyf8tsZnvG4GgkZe14LzjWrkDkagK185JjujtFpCfwuX9xEoXSzh5QdULX29GJTSZSxE0AVI="
    # QUAY_CMS_TOKEN
    - secure: "VDyxm8lfabtiJkLaZJKbo26CCm6jqvFjfFZyxtX6n+CygH7DGnjp1IyESzykZcZyJjP1BI8ttWarfgTVS0ivXkul935pOGJKWj/VSMsm6kx+xNNuKLb0MEU6PVrLJQ5mZWgM7OaLRS4NpIRW9+tNh5HgWWq8HiPi1JZNLt+w2MkCqyIWHU1GCqBIbXr+asLBimSTLNeWbEnIeHF07G8ue73WT99xtsk2gaLiEj1encpnnm88rrc7Yh/hI6dSSMgP+TyArYcZBfYg5J4mC1p53gVVlAbGp4+RbdVlilboj6EvPvHswkexPMSmCKxUTUpfLpFFgMCv8Z4koILmppmHHZkGM7bzNAvlBXUvUiFhxmOSLoE/gvqeozELc3aPW6dtC7I4ZlUpp/oyQdqfCgbbYN94+5XnP7LFVkCNzLpviB89eUruCklmDQcEGgBpw6XzzGJj2KfAwVeshj2cG1RNnKK/3FdmWHkJRGlmtObNs3rjfif/H97M76cZfTahJN8dvF5liiKvfc7e4j89fuZJlT4mzpS83W35/+H65Jl70Ue85rHvQ4XcjUFM6+2GUplTKBAH3XtNzsZq7bbSuQJvrzVwPxciZydAgg32wu/41pPwMD/+WeSZUWBI+Xazg/WyXf1KlzgQCVL+YBEhUjICnucbquCZW+EAkzsrQgO5a7M="
branches:
  except:
    - /.*-staging$/
    - /^staging-.*/

stages:
  - main

branches:
  except:
    - is-branch-info

jobs:
  fast_finish: true
  include:
    
    - language: python
      stage: main
      python: "3.8"
      before_install:
        - openssl aes-256-cbc -K $encrypted_cd0220f97c1a_key -iv $encrypted_cd0220f97c1a_iv -in terra/gcloud-config.tar.gz.enc -out terra/gcloud-config.tar.gz -d
        - sudo apt-get update || true
        - sudo apt-get -y install openjdk-8-jre-headless
      install:
        - pip3 -q install firecloud PyYAML
      script:
        - set -e
        - ./travis/test-wdl.sh
        - tar -xzf terra/gcloud-config.tar.gz -C $HOME
        - git submodule init docker/cms2-docker-component-stats
        - git submodule update --recursive docker/cms2-docker-component-stats
        - ./terra/terra_utils.py deploy_to_terra
